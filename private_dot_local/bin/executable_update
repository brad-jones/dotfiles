#!/usr/bin/env bash
set -euxo pipefail;

# Apply any changes from chezmoi
chezmoiV="$(wget https://github.com/twpayne/chezmoi/releases/latest -O /dev/null 2>&1 | grep Location: | sed -r 's~^.*tag/v(.*?) \[.*~\1~g')";
sudo dnf install -y https://github.com/twpayne/chezmoi/releases/download/v$chezmoiV/chezmoi-$chezmoiV-x86_64.rpm;
chezmoi apply;

# Update the base system
sudo dnf -y update;

# Update homebrew
brew update;
brew upgrade aws-vault;

# Update dart
latestDartV="$(curl -s https://storage.googleapis.com/dart-archive/channels/stable/release/latest/VERSION | jq -j '.version')";
if [ ! -d "$HOME/.dart/$latestDartV" ];
then
	curl "https://storage.googleapis.com/dart-archive/channels/stable/release/$latestDartV/sdk/dartsdk-linux-x64-release.zip" -o /tmp/dartsdk.zip;
	unzip /tmp/dartsdk.zip -d "$HOME/.dart";
	mv "$HOME/.dart/dart-sdk" "$HOME/.dart/$latestDartV";
	rm -f "$HOME/.dart/current";
	ln -s "$HOME/.dart/$latestDartV" "$HOME/.dart/current";
	rm -f /tmp/dartsdk.zip;
fi

# Update nodenv and install latest version of node
rm -rf /tmp/node-build*;
nodenv update;
nodenv update-version-defs;
nodeV="$(echo "$(nodenv install --list)" | awk '{$1=$1};1' | grep '^[0-9]' | grep -v '[a-zA-Z]' | sed '/-/!{s/$/_/}' | sort -V | sed 's/_$//' | tail -n1)";
nodenv install -s $nodeV;
nodenv global $nodeV;
npm install --global yarn;
npm install --global pnpm;
nodenv rehash;

# Update goenv and install latest version of go
rm -rf /tmp/go-build* /tmp/*install_goenv;
cd ~/.goenv && git pull && cd -;
cd ~/.goenv && src/configure && make -C src && cd -;
goV="$(echo "$(goenv install --list)" | awk '{$1=$1};1' | grep '^[0-9]' | grep -v '[a-zA-Z]' | sed '/-/!{s/$/_/}' | sort -V | sed 's/_$//' | tail -n1)";
goenv install -s $goV;
goenv global $goV;
goenv rehash;

# Update pyenv and install latest version of python
rm -rf /tmp/python-build*;
cd ~/.pyenv && git pull && cd -;
cd ~/.pyenv && src/configure && make -C src && cd -;
pythonV="$(echo "$(pyenv install --list)" | awk '{$1=$1};1' | grep '^[0-9]' | grep -v '[a-zA-Z]' | sed '/-/!{s/$/_/}' | sort -V | sed 's/_$//' | tail -n1)";
pyenv install -s $pythonV;
pyenv global $pythonV;
pyenv rehash;

# Update rbenv and install latest version of ruby
rm -rf /tmp/ruby-build*;
cd ~/.rbenv && git pull && cd -;
cd ~/.rbenv && src/configure && make -C src && cd -;
cd ~/.rbenv/plugins/ruby-build && git pull && cd -;
rubyV="$(echo "$(rbenv install --list)" | awk '{$1=$1};1' | grep '^[0-9]' | grep -v '[a-zA-Z]' | sed '/-/!{s/$/_/}' | sort -V | sed 's/_$//' | tail -n1)";
rbenv install -s $rubyV;
rbenv global $rubyV;
rbenv rehash;

# Update tfenv and install latest version of terraform
cd ~/.tfenv && git pull && cd -;
tfV="$(echo "$(tfenv list-remote)" | awk '{$1=$1};1' | grep '^[0-9]' | grep -v '[a-zA-Z]' | sed '/-/!{s/$/_/}' | sort -V | sed 's/_$//' | tail -n1)";
tfenv install $tfV;
tfenv use $tfV;

# Update pkenv and install latest version of packer
cd ~/.pkenv && git pull && cd -;
packerV="$(echo "$(pkenv list-remote)" | awk '{$1=$1};1' | grep '^[0-9]' | grep -v '[a-zA-Z]' | sed '/-/!{s/$/_/}' | sort -V | sed 's/_$//' | tail -n1)";
pkenv install $packerV;
pkenv use $packerV;

# Update awscli - depends on python
tmpFolder="/tmp/$(uuidgen)";
mkdir -p $tmpFolder;
function finish {
	rm -rf $tmpFolder;
}
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "$tmpFolder/awscliv2.zip";
unzip "$tmpFolder/awscliv2.zip" -d "$tmpFolder/extracted";
$tmpFolder/extracted/aws/install -i ~/.local/aws-cli -b ~/.local/bin --update;
aws --version;

# Update dotnet core
curl https://dotnet.microsoft.com/download/dotnet-core/scripts/v1/dotnet-install.sh | bash;
dotnet --info;

# Update sdkman, java and kotlin
bash ~/.local/bin/update-sdkman;